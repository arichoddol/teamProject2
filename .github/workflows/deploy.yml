name: Final CI/CD Pipeline - Docker Image Deploy (A-Z)

on:
  push:
    branches: [ "dev" ] 

jobs:
  deploy:
    runs-on: ubuntu-latest 
    
    steps:
      # 1. Checkout Code (소스 코드 가져오기)
      - name: 1. Checkout Code
        uses: actions/checkout@v4 

      - name: Set up JDK 17
        uses: actions/setup-java@v1
        with:
          java-version: '17'

      - name: 3. Grant execute permission & Build
        run: |
          chmod +x backendspring/gradlew
          cd backendspring
          ./gradlew clean bootJar
        shell: bash

      - name: 3.5. Transfer docker-compose.yml to EC2
        uses: appleboy/scp-action@v0.1.7 # 파일을 전송하는 액션 사용
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "docker-compose.yml" # Git Repository 루트에 있는 파일
          target: "/home/${{ secrets.EC2_USER }}" # EC2의 /home/ec2-user 디렉토리
          
      # 2. Docker Hub 로그인 (이미지 푸시/풀에 필요)
      - name: 4. Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: 5. Setup Swap Space for npm install
        if: runner.os == 'Linux'
        run: |
          echo "Allocating 4G swap file..."
          sudo fallocate -l 4G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          sudo swapon --show
          
      # 3. Docker 이미지 빌드 및 푸시 (YML 파일을 Secret으로 주입할 것이므로, 여기서는 임시 파일로 빌드)
      - name: 6. Build and Push Placeholder Images
        run: |
          # 백엔드 JAR 빌드 후 Docker 이미지 푸시
          docker build -t ther3fore/backendspring-backend:latest -f backendspring/Dockerfile . 
          docker push ther3fore/backendspring-backend:latest
          
          # 프론트엔드 이미지 푸시
          docker build -t ther3fore/vite-front-frontend:latest -f vite-front/Dockerfile . 
          docker push ther3fore/vite-front-frontend:latest

      # 4. Deploy to EC2 (Secret YML 파일 주입 및 실행)
      - name: 7. Deploy to EC2 via SSH (Image Pull & Run)
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |

            echo "${{ secrets.SPRING_APP_YML }}" > $YML_CONFIG_DIR/application.yml
            echo "${{ secrets.SPRING_OAUTH_YML }}" > $YML_CONFIG_DIR/application-oauth2.yml
            echo "Sensitive YML files created."

         
            cd /home/ec2-user   # /home/ec2-user에 docker-compose.yml 파일이 있어야 함
            docker-compose pull  # 최신 이미지 다운로드
            docker-compose up -d # 백그라운드에서 컨테이너 실행
            docker image prune -af  # 불필요한 이미지를 정리